{% extends "base.html" %} {% block title %}送信メールボックス -
脆弱なショッピングモール{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h3>📤 送信メールボックス</h3>
          <a href="/mail/compose" class="btn btn-primary">✏️ 新規メール</a>
        </div>
        <div class="card-body">
          {% if emails %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>受信者</th>
                  <th>件名</th>
                  <th>添付ファイル</th>
                  <th>送信日時</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                {% for email in emails %}
                <tr>
                  <td>{{ email[7] }}</td>
                  <td>
                    <a
                      href="/mail/read/{{ email[0] }}"
                      class="text-decoration-none"
                      onclick="previewEmail('{{ email[3] | safe }}'); return false;"
                      title="クリックで詳細プレビュー"
                    >
                      {{ email[3] }} {% if email[8] > 0 %} 📎 {% endif %}
                    </a>
                    <small class="d-block text-muted">
                      <a href="/mail/read/{{ email[0] }}" class="text-decoration-none">
                        📖 詳細を開く
                      </a>
                    </small>
                  </td>
                  <td>
                    {% if email[8] > 0 %}
                    <span class="badge bg-info">{{ email[8] }}個</span>
                    {% else %} - {% endif %}
                  </td>
                  <td>{{ email[6] }}</td>
                  <td>
                    <a
                      href="/mail/read/{{ email[0] }}"
                      class="btn btn-sm btn-outline-primary"
                      >👁️ 詳細</a
                    >
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <h4>📭 送信メールがありません</h4>
            <p class="text-muted">まだメールを送信していません。</p>
            <a href="/mail/compose" class="btn btn-primary">✏️ メール作成</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// メールプレビュー機能（XSS脆弱性あり）
function previewEmail(subject) {
    // プレビューダイアログを表示
    if (subject && subject.trim()) {
        // 脆弱性：件名をそのまま実行可能なコードとして処理
        var previewMsg = "件名: " + subject + "\\nクリックして詳細を確認しますか？";
        
        // さらなる脆弱性：eval使用
        try {
            eval('var displaySubject = "' + subject + '";');
            console.log('プレビュー対象: ' + displaySubject);
        } catch(e) {
            console.log('プレビューエラー: ' + e.message);
        }
        
        // プレビュー表示
        if (confirm(previewMsg)) {
            // 通常はメール詳細ページに遷移
            return true;
        }
    }
    return false;
}
</script>
{% endblock %}
